<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  
  <!-- Package Configuration (WiX v4+ syntax) -->
  <Package Name="Zero Trust Migration Journey Dashboard"
           Language="1033"
           Version="3.16.14.0"
           Manufacturer="Microsoft Configuration Manager"
           UpgradeCode="7B8C9D2E-4F5A-6B7C-8D9E-0F1A2B3C4D5E"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <!-- Summary Information -->
    <SummaryInformation Description="ConfigMgr to Intune migration tracking dashboard"
                        Manufacturer="Microsoft Configuration Manager" />

    <!-- Major Upgrade Strategy -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize"
                  AllowSameVersionUpgrades="no" />

    <!-- Embedded Cabinet -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Icon for Add/Remove Programs -->
    <Icon Id="ProductIcon" SourceFile="$(var.PublishDir)\ZeroTrustMigrationAddin.exe" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/sccmavenger/cmaddin" />

    <!-- Directory Structure -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="ManufacturerFolder" Name="Microsoft Configuration Manager">
        <Directory Id="AdminConsoleFolder" Name="AdminConsole">
          <Directory Id="BinFolder" Name="bin">
            <Directory Id="INSTALLFOLDER" Name="ZeroTrustMigrationAddin" />
          </Directory>
          <Directory Id="XmlStorageFolder" Name="XmlStorage">
            <Directory Id="ExtensionsFolder" Name="Extensions">
              <Directory Id="ActionsFolder" Name="Actions" />
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Zero Trust Migration Journey" />
    </StandardDirectory>

    <!-- Feature: Core Application -->
    <Feature Id="ProductFeature"
             Title="Zero Trust Migration Journey Dashboard"
             Description="Core application files"
             Level="1"
             AllowAbsent="no"
             AllowAdvertise="no">
      <ComponentGroupRef Id="ApplicationFiles" />
      <ComponentGroupRef Id="ExtensionManifest" />
    </Feature>

    <!-- Feature: Desktop Shortcut -->
    <Feature Id="DesktopShortcuts"
             Title="Desktop Shortcut"
             Description="Create a shortcut on the desktop"
             Level="1"
             AllowAdvertise="no">
      <ComponentGroupRef Id="DesktopShortcutComponent" />
    </Feature>

    <!-- Feature: Start Menu -->
    <Feature Id="StartMenuShortcuts"
             Title="Start Menu Shortcuts"
             Description="Create shortcuts in the Start Menu"
             Level="1"
             AllowAdvertise="no">
      <ComponentGroupRef Id="StartMenuComponents" />
    </Feature>

    <!-- UI -->
    <ui:WixUI Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

  </Package>

  <!-- ConfigMgr Extension Manifest Component -->
  <Fragment>
    <ComponentGroup Id="ExtensionManifest" Directory="ActionsFolder">
      <Component Id="ConfigMgrXmlManifest" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="ExtensionXml"
              Name="ZeroTrustMigrationAddin.xml"
              Source="..\ZeroTrustMigrationAddin.xml"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Desktop Shortcut Component -->
  <Fragment>
    <ComponentGroup Id="DesktopShortcutComponent" Directory="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901">
        <Shortcut Id="DesktopShortcut"
                  Name="Zero Trust Migration Journey"
                  Description="ConfigMgr to Intune migration dashboard"
                  Target="[INSTALLFOLDER]ZeroTrustMigrationAddin.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\ZeroTrustMigrationAddin"
                       Name="DesktopShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Start Menu Components -->
  <Fragment>
    <ComponentGroup Id="StartMenuComponents" Directory="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012">
        <Shortcut Id="StartMenuShortcut"
                  Name="Zero Trust Migration Journey"
                  Description="ConfigMgr to Intune migration dashboard"
                  Target="[INSTALLFOLDER]ZeroTrustMigrationAddin.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanupStartMenu" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\ZeroTrustMigrationAddin"
                       Name="StartMenuShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

</Wix>
