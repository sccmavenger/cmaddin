# GitHub Actions workflow to build and publish Zero Trust Migration Journey Add-in
# This workflow builds the application and publishes releases to GitHub

name: Build and Publish

on:
  # Manual trigger with version options
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.16.10). Leave empty for auto-increment.'
        required: false
        type: string
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'Patch'
        type: choice
        options:
          - Patch
          - Minor
          - Major
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean
      build_msi:
        description: 'Build MSI Installer'
        required: false
        default: false
        type: boolean

  # Automatic build on push to main with version tags
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_NAME: 'ZeroTrustMigrationAddin'
  CONFIGURATION: 'Release'

jobs:
  build:
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Determine Version
        id: version
        shell: pwsh
        run: |
          # Get current version from csproj
          [xml]$csproj = Get-Content "ZeroTrustMigrationAddin.csproj"
          $currentVersion = $csproj.Project.PropertyGroup.Version
          Write-Host "Current version in csproj: $currentVersion"
          
          # Parse version components
          $parts = $currentVersion -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]  
          $patch = [int]$parts[2]
          
          # Determine new version
          if ("${{ github.event.inputs.version }}" -ne "") {
            $newVersion = "${{ github.event.inputs.version }}"
          } elseif ("${{ github.ref_type }}" -eq "tag") {
            # Extract version from tag (remove 'v' prefix)
            $newVersion = "${{ github.ref_name }}" -replace '^v', ''
          } else {
            # Auto-increment based on bump type
            $bumpType = "${{ github.event.inputs.bump_type }}"
            if ($bumpType -eq "" ) { $bumpType = "Patch" }
            
            switch ($bumpType) {
              "Major" { $major++; $minor = 0; $patch = 0 }
              "Minor" { $minor++; $patch = 0 }
              "Patch" { $patch++ }
            }
            $newVersion = "$major.$minor.$patch"
          }
          
          Write-Host "Building version: $newVersion"
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
      
      - name: Update Version in Project Files
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          Write-Host "Updating all files to version: $version"
          
          # Update csproj
          $csprojPath = "ZeroTrustMigrationAddin.csproj"
          $csprojContent = Get-Content $csprojPath -Raw
          $csprojContent = $csprojContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
          $csprojContent = $csprojContent -replace '<AssemblyVersion>[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
          $csprojContent = $csprojContent -replace '<FileVersion>[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
          Set-Content -Path $csprojPath -Value $csprojContent -NoNewline
          
          # Update XML manifest
          $xmlPath = "CloudJourneyAddin.xml"
          if (Test-Path $xmlPath) {
            $xmlContent = Get-Content $xmlPath -Raw
            $xmlContent = $xmlContent -replace 'Version="[\d\.]+"', "Version=`"$version`""
            Set-Content -Path $xmlPath -Value $xmlContent -NoNewline
          }
          
          Write-Host "âœ… Version updated to $version in all project files"
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build Application
        run: |
          dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore
      
      - name: Publish Application
        run: |
          dotnet publish --configuration ${{ env.CONFIGURATION }} --output ./publish --self-contained true --runtime win-x64
      
      - name: Generate Manifest
        id: manifest
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $publishPath = "./publish"
          
          # Generate file hashes for delta update support
          $files = Get-ChildItem -Path $publishPath -Recurse -File | ForEach-Object {
            $relativePath = $_.FullName.Substring((Resolve-Path $publishPath).Path.Length + 1)
            $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower()
            @{
              RelativePath = $relativePath -replace '\\', '/'
              FileSize = $_.Length
              SHA256Hash = $hash
              LastModified = $_.LastWriteTimeUtc.ToString("o")
              IsCritical = $relativePath -match '(ZeroTrustMigrationAddin\.dll|Azure\.Identity\.dll)$'
            }
          }
          
          $totalSize = ($files | Measure-Object -Property FileSize -Sum).Sum
          
          $manifest = @{
            Version = $version
            TotalSize = $totalSize
            BuildDate = (Get-Date).ToUniversalTime().ToString("o")
            Files = $files
          }
          
          $manifestJson = $manifest | ConvertTo-Json -Depth 10
          Set-Content -Path "./publish/manifest.json" -Value $manifestJson
          
          # Also save to root for reference
          Set-Content -Path "./manifest-v$version.json" -Value $manifestJson
          
          Write-Host "âœ… Generated manifest.json with $($files.Count) files, total size: $([math]::Round($totalSize / 1MB, 2)) MB"
      
      - name: Create Package
        id: package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $artifactName = "ZeroTrustMigrationAddin-v$version"
          $zipPath = "./$artifactName.zip"
          
          # Create ZIP package
          Compress-Archive -Path "./publish/*" -DestinationPath $zipPath -Force
          
          # Calculate package hash
          $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower()
          $size = (Get-Item $zipPath).Length
          
          Write-Host "âœ… Created package: $zipPath"
          Write-Host "   Size: $([math]::Round($size / 1MB, 2)) MB"
          Write-Host "   SHA256: $hash"
          
          echo "artifact_name=$artifactName" >> $env:GITHUB_OUTPUT
          echo "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          echo "zip_hash=$hash" >> $env:GITHUB_OUTPUT
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: |
            ./${{ steps.package.outputs.artifact_name }}.zip
            ./manifest-v${{ steps.version.outputs.version }}.json
          retention-days: 30

  # MSI Build Job (optional)
  build-msi:
    runs-on: windows-latest
    needs: build
    if: ${{ github.event.inputs.build_msi == 'true' || github.ref_type == 'tag' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./artifacts
      
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          dotnet tool install --global wix --version 5.0.0
          Write-Host "âœ… WiX Toolset installed"
      
      - name: Build MSI Installer
        shell: pwsh
        run: |
          $version = "${{ needs.build.outputs.version }}"
          
          # Extract ZIP to staging area
          Expand-Archive -Path "./artifacts/ZeroTrustMigrationAddin-v$version.zip" -DestinationPath "./msi-staging" -Force
          
          # Build MSI using WiX
          if (Test-Path "./installer/Product.wxs") {
            Push-Location ./installer
            wix build Product.wxs -o "../ZeroTrustMigrationAddin-v$version.msi" -d Version=$version -d SourceDir="../msi-staging"
            Pop-Location
            Write-Host "âœ… MSI installer created"
          } else {
            Write-Host "âš ï¸ WiX source files not found, skipping MSI build"
          }
      
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}-msi
          path: ./*.msi
          retention-days: 30
          if-no-files-found: ignore

  # Release Job
  release:
    runs-on: ubuntu-latest
    needs: [build, build-msi]
    if: |
      always() && 
      needs.build.result == 'success' &&
      (github.event.inputs.create_release == 'true' || github.ref_type == 'tag')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts
      
      - name: Prepare Release Assets
        shell: bash
        run: |
          mkdir -p ./release-files
          find ./release-artifacts -name "*.zip" -exec cp {} ./release-files/ \;
          find ./release-artifacts -name "*.msi" -exec cp {} ./release-files/ \; 2>/dev/null || true
          find ./release-artifacts -name "manifest-*.json" -exec cp {} ./release-files/ \;
          ls -la ./release-files/
      
      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          CUSTOM_NOTES="${{ github.event.inputs.release_notes }}"
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          ## Zero Trust Migration Journey Add-in v$VERSION
          
          ### ðŸ“¦ Installation
          
          **New Installation:**
          1. Download `ZeroTrustMigrationAddin-v$VERSION.zip`
          2. Extract to ConfigMgr Console Extensions folder
          3. Restart ConfigMgr Console
          
          **Update Existing:**
          - Use the built-in auto-update feature, or
          - Download and replace existing files
          
          ### ðŸ”„ Delta Updates
          The `manifest.json` file enables delta updates - only changed files are downloaded.
          
          ### âœ… Verification
          ```powershell
          # Verify download integrity
          (Get-FileHash -Path "ZeroTrustMigrationAddin-v$VERSION.zip" -Algorithm SHA256).Hash
          ```
          
          ### ðŸ“‹ What's New
          EOF
          
          if [ -n "$CUSTOM_NOTES" ]; then
            echo "$CUSTOM_NOTES" >> release_notes.md
          else
            echo "See CHANGELOG.md for detailed changes." >> release_notes.md
          fi
          
          # Replace version placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: Zero Trust Migration Journey v${{ needs.build.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ./release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        shell: bash
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          echo "## ðŸŽ‰ Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -la ./release-files/ >> $GITHUB_STEP_SUMMARY
